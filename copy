// Функція для перевірки, чи блок має один із бажаних стилів
const hasCustomListStyle = (block) => {
    if (!block || !block.attributes || !block.attributes.className) {
        return false;
    }

    const { className } = block.attributes;
    return (
        className.includes('is-style-list-with-small-dots') ||
        className.includes('is-style-list-body-style') ||
        className.includes('is-style-bullet-list')
    );
};

// Додаємо панель для вибору кольору, якщо батьківський блок core/list має потрібний стиль
wp.hooks.addFilter(
    'editor.BlockEdit',
    'custom/list-item-color-control',
    (BlockEdit) => (props) => {
        const { attributes, setAttributes, name, clientId } = props;

        // Перевіряємо, чи це core/list-item
        if (name !== 'core/list-item') {
            return <BlockEdit {...props} />;
        }

        // Отримуємо батьківський блок core/list
        const parentBlocks = wp.data.select('core/block-editor').getBlockParents(clientId);
        const parentBlock = parentBlocks.length ? wp.data.select('core/block-editor').getBlock(parentBlocks[0]) : null;

        // Якщо батьківський блок не має потрібного стилю, не показуємо вибір кольору
        if (!parentBlock || !hasCustomListStyle(parentBlock)) {
            return <BlockEdit {...props} />;
        }

        const { bulletColor } = attributes;

        return (
            <>
                <BlockEdit {...props} />
                <wp.blockEditor.InspectorControls>
                    <wp.components.PanelBody title="Bullet Color" initialOpen={true}>
                        <wp.components.ColorPalette
                            value={bulletColor}
                            onChange={(color) => setAttributes({ bulletColor: color })}
                        />
                    </wp.components.PanelBody>
                </wp.blockEditor.InspectorControls>
            </>
        );
    }
);

// Додаємо кастомний data-атрибут для bulletColor
wp.hooks.addFilter(
    'blocks.getSaveContent.extraProps',
    'custom/list-item-bullet-color-props',
    (extraProps, blockType, attributes) => {
        if (blockType.name === 'core/list-item' && attributes.bulletColor) {
            // Додаємо атрибут data-bullet-color з вибраним кольором
            extraProps['data-bullet-color'] = attributes.bulletColor;
        }
        return extraProps;
    }
);

// Додаємо функцію для обробки кольору з атрибуту data-bullet-color
const applyBulletColor = () => {
    // Отримуємо всі елементи списку з data-bullet-color
    const listItems = document.querySelectorAll('[data-bullet-color]');

    listItems.forEach((item) => {
        const color = item.getAttribute('data-bullet-color');
        if (color) {
            // Додаємо inline-стиль для псевдоелемента ::before через CSS-перемінну
            item.style.setProperty('--bullet-color', color);

            const style = document.createElement('style');
            style.innerHTML = `
                [data-bullet-color="${color}"]::before {
                    color: ${color};
                }
            `;
            document.head.appendChild(style);
        }
    });
};

// Викликаємо applyBulletColor при завантаженні сторінки або після зміни блоків
wp.domReady(() => {
    applyBulletColor();
    wp.data.subscribe(() => {
        applyBulletColor();
    });
});